<div class="coin-page">
  <div class="coin-container">
    {{!-- é¡¶éƒ¨å¯¼èˆªæ  --}}
    <div class="coin-nav">
      <div class="coin-nav-left">
        <span class="coin-nav-icon">ğŸª™</span>
        <span class="coin-nav-title">{{model.coinName}}ä¸­å¿ƒ</span>
      </div>
      <div class="coin-nav-right">
        {{#if this.currentUser.admin}}
          <button class="coin-nav-btn" {{on "click" this.goToAdminPage}}>
            <i class="fa-solid fa-shield-halved"></i>
            <span>ç®¡ç†</span>
          </button>
        {{/if}}
        <button class="coin-nav-btn" {{on "click" this.refreshData}}>
          <i class="fa-solid fa-arrows-rotate"></i>
        </button>
      </div>
    </div>

    {{!-- ä½™é¢å¡ç‰‡ --}}
    <div class="coin-balance-section">
      <div class="coin-balance-card">
        <div class="balance-bg-pattern"></div>
        <div class="balance-content">
          <div class="balance-icon-wrap">
            <i class="fa-solid fa-coins"></i>
          </div>
          <div class="balance-info">
            <span class="balance-label">å¯ç”¨ä½™é¢</span>
            <div class="balance-amount-wrap">
              <span class="balance-amount">{{this.formattedBalance}}</span>
              <span class="balance-unit">{{model.coinName}}</span>
            </div>
          </div>
        </div>
        <div class="balance-actions">
          {{#if this.coinInvoiceEnabled}}
            <button class="balance-action-btn primary" {{on "click" this.openInvoiceModal}}>
              <i class="fa-solid fa-file-invoice"></i>
              <span>ç”³è¯·å‘ç¥¨</span>
            </button>
          {{/if}}
          <button class="balance-action-btn secondary" {{on "click" this.goToInvoicePage}}>
            <i class="fa-solid fa-receipt"></i>
            <span>å‘ç¥¨è®°å½•</span>
          </button>
        </div>
      </div>
    </div>

    {{!-- å¿«æ·æ“ä½œ --}}
    <div class="coin-quick-actions">
      <div class="quick-action-item" {{on "click" this.goToInvoicePage}}>
        <div class="quick-action-icon blue">
          <i class="fa-solid fa-clock-rotate-left"></i>
        </div>
        <span class="quick-action-text">å†å²è®°å½•</span>
      </div>
      <div class="quick-action-item" {{on "click" this.openInvoiceModal}}>
        <div class="quick-action-icon green">
          <i class="fa-solid fa-file-circle-plus"></i>
        </div>
        <span class="quick-action-text">å¼€å‘ç¥¨</span>
      </div>
      <div class="quick-action-item">
        <div class="quick-action-icon orange">
          <i class="fa-solid fa-circle-question"></i>
        </div>
        <span class="quick-action-text">å¸®åŠ©</span>
      </div>
    </div>

    {{!-- äº¤æ˜“è®°å½• --}}
    <div class="coin-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fa-solid fa-list-ul"></i>
          <span>äº¤æ˜“è®°å½•</span>
        </h2>
        <span class="section-badge">{{model.transactions.length}}</span>
      </div>
      
      <div class="transactions-container">
        {{#if model.transactions}}
          {{#each model.transactions as |transaction|}}
            <div class="transaction-card">
              <div class="transaction-left">
                <div class="transaction-icon {{transaction.transaction_type}}">
                  {{#if (eq transaction.transaction_type "recharge")}}
                    <i class="fa-solid fa-arrow-down"></i>
                  {{else if (eq transaction.transaction_type "admin_adjust")}}
                    <i class="fa-solid fa-sliders"></i>
                  {{else}}
                    <i class="fa-solid fa-arrow-up"></i>
                  {{/if}}
                </div>
                <div class="transaction-details">
                  <span class="transaction-title">{{transaction.reason}}</span>
                  <span class="transaction-meta">
                    {{#if (eq transaction.transaction_type "recharge")}}
                      å……å€¼
                    {{else if (eq transaction.transaction_type "admin_adjust")}}
                      ç³»ç»Ÿè°ƒæ•´
                    {{else}}
                      æ¶ˆè´¹
                    {{/if}}
                    Â· {{format-date transaction.created_at format="medium"}}
                  </span>
                </div>
              </div>
              <div class="transaction-right">
                <span class="transaction-amount {{if (gt transaction.amount 0) 'positive' 'negative'}}">
                  {{#if (gt transaction.amount 0)}}+{{/if}}{{transaction.amount}}
                </span>
                {{#if (and this.coinInvoiceEnabled (eq transaction.transaction_type "recharge"))}}
                  <button class="transaction-invoice-btn" {{on "click" (fn this.openInvoiceFromTransactionModal transaction)}}>
                    <i class="fa-solid fa-file-invoice"></i>
                  </button>
                {{/if}}
              </div>
            </div>
          {{/each}}
        {{else}}
          <div class="empty-state">
            <div class="empty-icon">
              <i class="fa-solid fa-inbox"></i>
            </div>
            <span class="empty-title">æš‚æ— äº¤æ˜“è®°å½•</span>
            <span class="empty-desc">æ‚¨çš„äº¤æ˜“è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º</span>
          </div>
        {{/if}}
      </div>
    </div>
  </div>

  {{!-- ç”³è¯·å‘ç¥¨æ¨¡æ€æ¡† --}}
  {{#if this.showInvoiceModal}}
    <div class="coin-modal-overlay" {{on "click" this.closeInvoiceModal}}>
      <div class="coin-modal" {{on "click" this.stopPropagation}}>
        <div class="modal-header">
          <div class="modal-title-wrap">
            <i class="fa-solid fa-file-invoice"></i>
            <h3>ç”³è¯·å‘ç¥¨</h3>
          </div>
          <button class="modal-close-btn" {{on "click" this.closeInvoiceModal}}>
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-field">
            <label class="form-label">ç”³è¯·é‡‘é¢</label>
            <div class="input-with-suffix">
              <input
                type="number"
                class="form-input"
                placeholder="è¯·è¾“å…¥é‡‘é¢"
                value={{this.invoiceAmount}}
                {{on "input" this.updateInvoiceAmount}}
              />
              <span class="input-suffix">{{model.coinName}}</span>
            </div>
            <span class="form-hint">å¯ç”¨ä½™é¢: {{this.formattedBalance}} {{model.coinName}}</span>
          </div>
          <div class="form-field">
            <label class="form-label">ç”³è¯·åŸå›  <span class="optional">(å¯é€‰)</span></label>
            <textarea
              class="form-textarea"
              placeholder="è¯·è¾“å…¥ç”³è¯·åŸå› ..."
              rows="3"
              value={{this.invoiceReason}}
              {{on "input" this.updateInvoiceReason}}
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel" {{on "click" this.closeInvoiceModal}}>å–æ¶ˆ</button>
          <button class="modal-btn primary" {{on "click" this.submitInvoiceRequest}} disabled={{this.isLoading}}>
            {{#if this.isLoading}}
              <i class="fa-solid fa-spinner fa-spin"></i>
              <span>æäº¤ä¸­...</span>
            {{else}}
              <i class="fa-solid fa-paper-plane"></i>
              <span>æäº¤ç”³è¯·</span>
            {{/if}}
          </button>
        </div>
      </div>
    </div>
  {{/if}}

  {{!-- ä»äº¤æ˜“ç”³è¯·å‘ç¥¨æ¨¡æ€æ¡† --}}
  {{#if this.showInvoiceFromTransactionModal}}
    <div class="coin-modal-overlay" {{on "click" this.closeInvoiceFromTransactionModal}}>
      <div class="coin-modal" {{on "click" this.stopPropagation}}>
        <div class="modal-header">
          <div class="modal-title-wrap">
            <i class="fa-solid fa-file-invoice"></i>
            <h3>ä»äº¤æ˜“ç”³è¯·å‘ç¥¨</h3>
          </div>
          <button class="modal-close-btn" {{on "click" this.closeInvoiceFromTransactionModal}}>
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="transaction-summary">
            <span class="summary-label">äº¤æ˜“é‡‘é¢</span>
            <span class="summary-value">{{this.selectedTransactionAmount}} {{model.coinName}}</span>
          </div>
          <div class="form-field">
            <label class="form-label">ç”³è¯·é‡‘é¢</label>
            <div class="input-with-suffix">
              <input
                type="number"
                class="form-input"
                placeholder="è¯·è¾“å…¥é‡‘é¢"
                value={{this.invoiceAmount}}
                {{on "input" this.updateInvoiceAmount}}
              />
              <span class="input-suffix">{{model.coinName}}</span>
            </div>
          </div>
          <div class="form-field">
            <label class="form-label">ç”³è¯·åŸå›  <span class="optional">(å¯é€‰)</span></label>
            <textarea
              class="form-textarea"
              placeholder="è¯·è¾“å…¥ç”³è¯·åŸå› ..."
              rows="3"
              value={{this.invoiceReason}}
              {{on "input" this.updateInvoiceReason}}
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel" {{on "click" this.closeInvoiceFromTransactionModal}}>å–æ¶ˆ</button>
          <button class="modal-btn primary" {{on "click" this.submitInvoiceFromTransaction}} disabled={{this.isLoading}}>
            {{#if this.isLoading}}
              <i class="fa-solid fa-spinner fa-spin"></i>
              <span>æäº¤ä¸­...</span>
            {{else}}
              <i class="fa-solid fa-paper-plane"></i>
              <span>æäº¤ç”³è¯·</span>
            {{/if}}
          </button>
        </div>
      </div>
    </div>
  {{/if}}

  {{!-- æˆåŠŸæç¤º --}}
  {{#if this.showSuccessMessage}}
    <div class="coin-toast success">
      <i class="fa-solid fa-circle-check"></i>
      <span>{{this.successMessage}}</span>
    </div>
  {{/if}}
</div>
