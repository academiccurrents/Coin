<div class="coin-page coin-admin-page">
  <div class="coin-container">
    {{!-- 顶部导航栏 --}}
    <div class="coin-nav">
      <div class="coin-nav-left">
        <button class="coin-nav-back" {{on "click" this.goToCoinPage}}>
          {{d-icon "arrow-left"}}
        </button>
        <span class="coin-nav-icon">⚙️</span>
        <span class="coin-nav-title">管理员面板</span>
      </div>
      <div class="coin-nav-right">
        <button class="coin-nav-btn" {{on "click" this.refreshData}}>
          {{d-icon "sync"}}
        </button>
      </div>
    </div>

    {{!-- 统计卡片 --}}
    <div class="admin-stats-grid">
      <div class="stat-card blue">
        <div class="stat-icon">
          {{d-icon "users"}}
        </div>
        <div class="stat-content">
          <span class="stat-value">{{this.statistics.total_users}}</span>
          <span class="stat-label">总用户数</span>
        </div>
      </div>
      <div class="stat-card gold">
        <div class="stat-icon">
          {{d-icon "dollar-sign"}}
        </div>
        <div class="stat-content">
          <span class="stat-value">{{this.statistics.total_balance}}</span>
          <span class="stat-label">总积分</span>
        </div>
      </div>
      <div class="stat-card green">
        <div class="stat-icon">
          {{d-icon "chart-line"}}
        </div>
        <div class="stat-content">
          <span class="stat-value">{{this.statistics.average_balance}}</span>
          <span class="stat-label">平均积分</span>
        </div>
      </div>
    </div>

    {{!-- 查询用户 --}}
    <div class="coin-section">
      <div class="section-header">
        <h2 class="section-title">
          {{d-icon "search"}}
          <span>查询用户</span>
        </h2>
      </div>
      <div class="admin-form">
        <div class="form-row">
          <div class="form-field flex-1">
            <input
              type="text"
              class="form-input"
              placeholder="输入用户名查询..."
              value={{this.queryUsername}}
              {{on "input" this.updateQueryUsername}}
            />
          </div>
          <button class="form-btn primary" {{on "click" this.queryUserBalance}} disabled={{this.isLoading}}>
            {{#if this.isLoading}}
              {{d-icon "spinner" class="fa-spin"}}
            {{else}}
              {{d-icon "search"}}
            {{/if}}
            <span>查询</span>
          </button>
        </div>
      </div>

      {{#if this.showQueryResult}}
        <div class="query-result-card">
          <div class="query-result-header">
            <div class="query-user-info">
              <span class="query-username">{{this.queryResult.username}}</span>
              <span class="query-balance">余额: <strong>{{this.queryResult.balance}}</strong></span>
            </div>
            <button class="query-close-btn" {{on "click" this.closeQueryResult}}>
              {{d-icon "times"}}
            </button>
          </div>
          <div class="query-transactions">
            <h4>最近交易记录</h4>
            {{#if this.queryResult.transactions}}
              {{#each this.queryResult.transactions as |transaction|}}
                <div class="mini-transaction">
                  <span class="mini-transaction-reason">{{transaction.reason}}</span>
                  <span class="mini-transaction-amount {{if (gt transaction.amount 0) 'positive' 'negative'}}">
                    {{#if (gt transaction.amount 0)}}+{{/if}}{{transaction.amount}}
                  </span>
                </div>
              {{/each}}
            {{else}}
              <div class="empty-mini">暂无交易记录</div>
            {{/if}}
          </div>
        </div>
      {{/if}}
    </div>

    {{!-- 调整积分 --}}
    <div class="coin-section">
      <div class="section-header">
        <h2 class="section-title">
          {{d-icon "sliders-h"}}
          <span>调整积分</span>
        </h2>
      </div>
      <div class="admin-form">
        <div class="form-row">
          <div class="form-field">
            <label class="form-label">用户名</label>
            <input
              type="text"
              class="form-input"
              placeholder="输入用户名"
              value={{this.adjustUsername}}
              {{on "input" this.updateAdjustUsername}}
            />
          </div>
          <div class="form-field">
            <label class="form-label">调整数量</label>
            <input
              type="number"
              class="form-input"
              placeholder="正数增加，负数扣除"
              value={{this.adjustAmount}}
              {{on "input" this.updateAdjustAmount}}
            />
          </div>
        </div>
        <div class="form-field">
          <label class="form-label">调整原因 <span class="optional">(可选)</span></label>
          <input
            type="text"
            class="form-input"
            placeholder="输入调整原因"
            value={{this.adjustReason}}
            {{on "input" this.updateAdjustReason}}
          />
        </div>
        <button class="form-btn primary full-width" {{on "click" this.adjustPoints}} disabled={{this.isLoading}}>
          {{#if this.isLoading}}
            {{d-icon "spinner" class="fa-spin"}}
            <span>处理中...</span>
          {{else}}
            {{d-icon "check"}}
            <span>确认调整</span>
          {{/if}}
        </button>
      </div>
    </div>

    {{!-- 待处理发票 --}}
    <div class="coin-section">
      <div class="section-header">
        <h2 class="section-title">
          {{d-icon "file-alt"}}
          <span>待处理发票</span>
        </h2>
        <span class="section-badge warning">{{this.pendingInvoices.length}}</span>
      </div>
      <div class="invoice-list">
        {{#if this.pendingInvoices}}
          {{#each this.pendingInvoices as |invoice|}}
            <div class="invoice-card pending">
              <div class="invoice-left">
                <div class="invoice-icon">
                  {{d-icon "clock"}}
                </div>
                <div class="invoice-info">
                  <span class="invoice-user">{{invoice.username}}</span>
                  <span class="invoice-amount">{{invoice.amount}} 硬币</span>
                  <span class="invoice-reason">{{invoice.reason}}</span>
                </div>
              </div>
              <button class="invoice-action-btn" {{on "click" (fn this.openProcessInvoiceModal invoice)}}>
                {{d-icon "check"}}
                <span>处理</span>
              </button>
            </div>
          {{/each}}
        {{else}}
          <div class="empty-state small">
            {{d-icon "inbox"}}
            <span>暂无待处理发票</span>
          </div>
        {{/if}}
      </div>
    </div>

    {{!-- 最近充值 --}}
    <div class="coin-section">
      <div class="section-header">
        <h2 class="section-title">
          {{d-icon "history"}}
          <span>最近充值</span>
        </h2>
      </div>
      <div class="transactions-container">
        {{#if this.recentTransactions}}
          {{#each this.recentTransactions as |transaction|}}
            <div class="transaction-card">
              <div class="transaction-left">
                <div class="transaction-icon recharge">
                  {{d-icon "arrow-down"}}
                </div>
                <div class="transaction-details">
                  <span class="transaction-title">{{transaction.username}}</span>
                  <span class="transaction-meta">{{transaction.reason}}</span>
                </div>
              </div>
              <div class="transaction-right">
                <span class="transaction-amount positive">+{{transaction.amount}}</span>
              </div>
            </div>
          {{/each}}
        {{else}}
          <div class="empty-state small">
            {{d-icon "inbox"}}
            <span>暂无充值记录</span>
          </div>
        {{/if}}
      </div>
    </div>
  </div>

  {{!-- 处理发票模态框 --}}
  {{#if this.showProcessInvoiceModal}}
    <div class="coin-modal-overlay" {{on "click" this.closeProcessInvoiceModal}}>
      <div class="coin-modal" {{on "click" this.stopPropagation}}>
        <div class="modal-header">
          <div class="modal-title-wrap">
            {{d-icon "file-alt"}}
            <h3>处理发票</h3>
          </div>
          <button class="modal-close-btn" {{on "click" this.closeProcessInvoiceModal}}>
            {{d-icon "times"}}
          </button>
        </div>
        <div class="modal-body">
          <div class="form-field">
            <label class="form-label">发票URL</label>
            <input
              type="url"
              class="form-input"
              placeholder="请输入发票图片URL"
              value={{this.invoiceUrl}}
              {{on "input" this.updateInvoiceUrl}}
            />
            <span class="form-hint">请上传发票图片到图床，然后粘贴URL</span>
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel" {{on "click" this.closeProcessInvoiceModal}}>取消</button>
          <button class="modal-btn primary" {{on "click" this.processInvoice}} disabled={{this.isLoading}}>
            {{#if this.isLoading}}
              {{d-icon "spinner" class="fa-spin"}}
              <span>处理中...</span>
            {{else}}
              {{d-icon "check"}}
              <span>确认处理</span>
            {{/if}}
          </button>
        </div>
      </div>
    </div>
  {{/if}}

  {{!-- 成功提示 --}}
  {{#if this.showSuccessMessage}}
    <div class="coin-toast success">
      {{d-icon "check-circle"}}
      <span>{{this.successMessage}}</span>
    </div>
  {{/if}}
</div>
